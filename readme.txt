TVのリモコン with NatureRemo.alfredworkflowのメモ

機能：
NatureRemoのAPIでTVをリモコン操作する
※conditionalユーティリティ、export禁止変数のサンプルです

インストール：
  1.alfredworkflowをダウンロード
  2.ファイルをダブルクリックしてワークフローに登録
  3.NatureRemoのアクセス用トークンを入力し変数を設定（インストール後で可能）
    ※ワークフロー右上の[χ]をクリックして設定
  4.多分スクリプトにある$IDも変更が必要（インストール後に変更）
    ※Run Scriptを開いて書き換え

使い方：
　⌃t（HOTKEYはご自身で設定が必要です）でテレビのON/OFF

　TV（キーワード）とパラメータでテレビをコントロール
　例）
　　TV（パラメータなし）　ON/OFF
　　TV　数字/文字　      チャンネル変更
　　TV　+/-　           Vol変更


開発メモ：

1.NatureRemoのAPI

　URLでNatureRemoをコントロールできます
　Tokenの取得やAPIの詳細はインターネットで調べてください
　APIはCURLのPOSTで操作が可能ですのでターミナルで遊んでみてください

　Tokenは個々のNatureRemoへのアクセス用になるので、公開できない情報です
　（公開するとあなたの家電を第3者がコントロールできちゃいますから）
　

2.export禁止変数

　tokenのような情報はexport禁止の変数として管理します
　ワークフロー右上の[χ]をクリックして変数の一覧を表示させてください
　インストール後には、Nameがtoken、valueが空欄、Don't Exportがチェック状態となっています
　valueにご自身の使いたいNatureRemoのトークンを貼り付けてください
　引用符は不要です


3.キーワード（TV）入力時のパラメータ

　パラメータなしとパラメータありをサポートしたいのでArgument Optionalを指定しています
　この後のconditionalユーティリティでパラメータに応じた処理の分岐を制御しています


4.入力パラメータによって処理を分岐させる（conditionalユーティリティ）

　今回のconditionalユーティリティは4分岐としています
　シェルスクリプトのソースは基本コマンドラインの集合で、構造化に向いていないので
　このように分岐させるとわかりやすいかな

　conditionalユーティリティを開いてみてください
　1行目の条件はパラメータがない状態を意味します（『is equal to』と『（空欄）』）
　なお『then』のあとのテキスト（『On/Off』）はalfredワークフローをわかりやすくするための表示用文字列です
　ソースコードを書くような感じに見えますが勘違いしないようにご注意ください

　2行目の条件（『matches regex』）は正規表現で条件を指定することができます
　『+』,『++』,・・・と『+』10個までの文字列にマッチします
　実は結構難しく、試行錯誤を繰り返してしまいましたが『^\+{1,10}$』に落ち着きました
 
　3行目は上記のマイナスバージョンです
　後続のRun Scriptはほぼ同じですが、remo操作用のIDが異なるので、ここで分岐させました

　4行目はその他でチャンネル変更になります
　数字や文字での指定が可能ですが、詳細はスクリプトで実装します


5.APIを利用する

　特に工夫した部分はなく、シェルスクリプトに書けばできちゃう感じです
　atureRemoのAPIでは、tokenとIDで、どのNatureRemoで何の操作をするかを指定します
　tokenは変数として固有の値を指定しているので、スクリプト内では$tokenとして記述できます
　curlのコマンドに埋め込んでいますので確認してみてください

　channel以外のスクリプトはスクリプト内で1つのIDしか利用していませんが、
　それぞれの環境でIDが異なるのでcurlに直で書かずに、変数としてセットしています
　またCurlが長文になるので\で区切って改行させています

　ヴォリューム用のスクリプトでは文字の長さの分だけ繰り返し処理をしています
　下記の＄{#1}がパラメータの長さを取得するコードです
　『++』であれば2、『---』であれば3となります

　for ((i=0;i<${#1};i++)) ; do



4.チャンネル変更用のIDをセットする

　チャンネル変更のスクリプトはcaseで多重分岐を処理しています
　条件が文字列マッチで、正規表現のように|がorの意味です

　ちなみにcaseはesacで締め、ifはfiで締めていて粋な感じですね
　for（というかdo?）はrofでなないのですね
　
　

背景：
　NatureRemoはアレクサ（AmazonEcho）と連携させて使っています
　『アレクサ、TVつけて』と一人の時は良いのですが、
　最近耳の遠くなった母親が何か呼んだ？と反応してしまうこともしばしば。
　ということでPCで操作できるのは良いかなと満足しています（何、NatureRemoアプリで良いですと！）
　複数のremoや色々なスマート家電があるので応用範囲が広そうですね


ver1.0既知のバグ
 チャンネル変更でetvをセットする条件が誤っていました
 3|etv|eとなっていますが、2|etv|eが正解です
 セットするIDについても違っていました。下記が正しいものですが、NatureRemo登録の仕方で変わります（バージョンや製品で変わるかもしれません）
 e8c7cff1-343e-4b5f-ae0b-fdb4927307aa　（NatuerRemoのデフォルトアイコン2に相当するものす。もとのワークフローでは3相当のIDでした）
 
ver1.1
 TV番組表.alfredworkflowと連携させるため、青い部分を追加しています
 開発メモ等の詳細は、https://github.com/KitanoTamotsu/tv をご覧ください



